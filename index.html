<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>GIS考研院校分布可视化系统</title>
    <style>
        html, body { 
            margin: 0;
            padding: 0;
            height: 100%;
        }
        .container {
            display: flex;
            height: 100%;
        }
        #map {
            flex: 1;
            position: relative;
        }
        .sidebar {
            width: 300px;
            background: #f8f8f8;
            padding: 20px;
            overflow-y: auto;
        }
        .school-info-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 600px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
            display: none;
        }
        .province-group {
            margin-bottom: 10px;
        }
        .province-header {
            background: #eee;
            padding: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .province-header.active .arrow {
            transform: rotate(180deg);
        }
        .province-schools {
            display: none;
            padding: 8px 0;
        }
        .province-schools.active {
            display: block;
        }
        .school-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .school-item:hover {
            background: #f0f0f0;
        }
        .school-item small {
            color: #666;
            display: block;
            margin-top: 4px;
        }
        .map-controls {
            position: absolute;
            right: 10px;
            bottom: 10px;
            z-index: 1000;
            display: flex;
            gap: 5px;
            flex-direction: column;
        }
        .map-control-group {
            display: flex;
            gap: 5px;
        }
        .map-control-button {
            width: 32px;
            height: 32px;
            background: white;
            border: none;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #333;
        }
        .map-control-button.active {
            background: #4a89dc;
            color: white;
        }
        .map-control-button:hover {
            background: #f0f0f0;
        }
        .map-control-button.active:hover {
            background: #357abd;
        }
        .search-box {
            margin-bottom: 20px;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .search-input:focus {
            outline: none;
            border-color: #4a89dc;
            box-shadow: 0 0 0 2px rgba(74, 137, 220, 0.2);
        }
        .search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 18px;
            display: none;
        }
        .search-clear:hover {
            color: #666;
        }
        .favorite-tab {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .tab-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #eee;
            cursor: pointer;
            flex: 1;
        }
        .tab-button.active {
            background: #4a89dc;
            color: white;
        }
        .rating-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .rating-items-container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .rating-item {
            flex: 1;
            text-align: center;
        }
        .rating-item label {
            display: block;
            margin-bottom: 8px;
            color: #666;
            font-size: 13px;
        }
        .rating-stars {
            display: flex;
            gap: 3px;
            justify-content: center;
        }
        .star {
            cursor: pointer;
            font-size: 18px;
            color: #ddd;
        }
        .star.active {
            color: #ffd700;
        }
        .favorite-button {
            margin-top: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #4a89dc;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .favorite-button.favorited {
            background: #dc4a4a;
        }
        .favorite-button:hover {
            opacity: 0.9;
        }
        .view-switch {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .view-switch-button {
            padding: 6px 12px;
            border: 1px solid #4a89dc;
            border-radius: 4px;
            background: white;
            color: #4a89dc;
            cursor: pointer;
            font-size: 13px;
        }
        .view-switch-button.active {
            background: #4a89dc;
            color: white;
        }
        .tier-group {
            margin-bottom: 10px;
        }
        .tier-header {
            background: #4a89dc;
            color: white;
            padding: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px;
        }
        .tier-header .arrow {
            color: white;
        }
        .tier-schools {
            display: none;
            padding: 8px 0;
        }
        .tier-schools.active {
            display: block;
        }
        .site-logo {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 15px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .site-logo img {
            width: 24px;
            height: 24px;
        }
        .province-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 8px;
        }

        .province-controls {
            display: flex;
            gap: 8px;
        }

        .province-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .province-btn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .zoom-btn {
            color: #3498db;
        }

        .expand-btn {
            color: #666;
        }

        .province-header {
            cursor: default;
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
        }

        .province-schools {
            display: none;
        }

        .province-schools.active {
            display: block;
        }

        .statistics-panel {
            padding: 15px;
            background: white;
            border-radius: 4px;
            margin-top: 10px;
        }

        .statistics-panel > div {
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            position: relative;
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .close-btn {
            position: absolute;
            right: 20px;
            top: 10px;
            color: #666;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover {
            color: #333;
        }

        .statistics-container {
            padding: 20px 0;
        }

        .statistics-container > div {
            margin-bottom: 40px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            background-color: white;
        }

        .modal h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
    </style>
    <script>
        window._AMapSecurityConfig = {
            securityJsCode: '35baddcb7a438e2e024fb75d1025068a'
        }
    </script>
    <script src="https://webapi.amap.com/maps?v=2.0&key=35baddcb7a438e2e024fb75d1025068a&plugin=AMap.HeatMap"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://cdn.bootcdn.net/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
</head>
<body>
    <div class="container">
        <div id="map">
            <div class="site-logo">
                <img src="data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Ccircle cx='12' cy='12' r='10' fill='%234a89dc'/%3E%3Cpath d='M12 6l4 4-4 4-4-4 4-4zM8 14l4 4 4-4-4 4-4-4z' fill='white'/%3E%3C/svg%3E" alt="logo">
                GIS考研院校分布可视化系统（不含港澳台）
            </div>
            <div id="schoolInfo" class="school-info-panel"></div>
            <div class="map-controls">
                <div class="map-control-group">
                    <button class="map-control-button" id="satelliteToggle" title="切换卫星图">🛰️</button>
                    <button class="map-control-button" id="heatmapToggle" title="切换热力图">🌡️</button>
                </div>
                <div class="map-control-group">
                    <button class="map-control-button" id="zoomIn" title="放大">+</button>
                    <button class="map-control-button" id="zoomOut" title="缩小">-</button>
                    <button class="map-control-button" id="zoomFit" title="缩放至全国范围">⟲</button>
                </div>
            </div>
        </div>
        <div class="sidebar">
            <h2>GIS考研院校列表</h2>
            <div class="favorite-tab">
                <button class="tab-button active" id="allSchools">所有院校</button>
                <button class="tab-button" id="favorites">我的收藏</button>
                <button class="tab-button" id="statistics">数据统计</button>
            </div>
            <div class="view-switch">
                <button class="view-switch-button active" id="viewByProvince">按省份查看</button>
                <button class="view-switch-button" id="viewByTier">按层级查看</button>
                <button class="view-switch-button" id="clearFavorites" style="display: none; font-size: 12px; padding: 4px 8px; background-color: #e74c3c; color: white;">清空收藏</button>
            </div>
            <div class="search-box">
                <input type="text" class="search-input" id="searchInput" placeholder="搜索院校名称...">
                <span class="search-clear" id="searchClear">×</span>
            </div>
            <div id="schoolList"></div>
        </div>
    </div>

    <div id="statisticsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>GIS院校数据统计</h2>
            <div class="statistics-container">
                <div id="modalProvinceChart" style="width: 100%; height: 400px;"></div>
                <div id="modalTierChart" style="width: 100%; height: 400px;"></div>
                <div id="modalStudentChart" style="width: 100%; height: 400px;"></div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let schools = [];
        let favorites = JSON.parse(localStorage.getItem('favorites') || '{}');
        let currentView = 'province'; // 'province' or 'tier'
        let satelliteLayer;
        let heatmap;
        let isHeatmapVisible = false;
        let isSatelliteVisible = false;
        let currentMarker = null; // 跟踪当前选中的标记
        let currentHighlightedMarker = null; // 添加全局变量用于跟踪当前高亮的标记
        let currentPolygon = null;
        let districtExplorer; // 将districtExplorer移到全局作用域

        // 定义院校层级
        const SCHOOL_TIERS = {
            '985': [
                '北京大学', '清华大学', '浙江大学', '复旦大学', '南京大学', 
                '中山大学', '武汉大学', '华中科技大学', '同济大学', '东北大学',
                '华东师范大学', '北京师范大学', '兰州大学'
            ],
            '211': [
                '北京大学', '清华大学', '浙江大学', '复旦大学', '南京大学', 
                '中山大学', '武汉大学', '华中科技大学', '同济大学', '东北大学',
                '华东师范大学', '北京师范大学', '中国地质大学(武汉)', '中国矿业大学',
                '河海大学', '南京师范大学', '东北师范大学', '云南大学', '西北大学',
                '陕西师范大学', '兰州大学', '北京林业大学', '中国地质大学(北京)',
                '宁夏大学', '合肥工业大学', '华南师范大学', '新疆大学', '石河子大学',
                '郑州大学', '华中师范大学', '福州大学', '西南大学', '长安大学'
            ]
        };

        // 获取学校层级
        function getSchoolTier(schoolName) {
            const tiers = [];
            // 精确匹配校名称
            if (SCHOOL_TIERS['985'].includes(schoolName)) {
                tiers.push('985');
            }
            if (SCHOOL_TIERS['211'].includes(schoolName)) {
                tiers.push('211');
            }
            return tiers;
        }

        // 从JSON文件加载数据
        async function loadData() {
            try {
                const response = await fetch('output/gis_schools.json');
                schools = await response.json();
                console.log('加载了 ' + schools.length + ' 所学校');
                initMap();
                createSchoolList();
                initSearch();  // 初始化搜索功能
            } catch (error) {
                console.error('数据加载失败:', error);
            }
        }

        // 显示学校信息
        function showSchoolInfo(school) {
            const infoPanel = document.getElementById('schoolInfo');
            const isFavorite = favorites[school.name];
            
            infoPanel.innerHTML = `
                <div style="padding: 20px; font-size: 14px;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3 style="margin: 0; color: #2c3e50;">
                            ${school.name}
                            ${getSchoolTier(school.name).map(tier => 
                                `<span style="font-size: 12px; padding: 2px 6px; margin-left: 8px; border-radius: 3px; background-color: ${tier === '985' ? '#e74c3c' : '#3498db'}; color: white;">${tier}</span>`
                            ).join('')}
                        </h3>
                        <button class="favorite-button ${isFavorite ? 'favorited' : ''}" onclick="toggleFavorite('${school.name}')">
                            ${isFavorite ? '★ 已收藏' : '☆ 收藏'}
                        </button>
                    </div>
                    <p style="margin: 10px 0; color: #666;">${school.province}，招生人数：${school.total_students}人</p>
                    
                    ${isFavorite ? `
                    <div class="rating-section">
                        <h4 style="margin: 0 0 15px 0; color: #2c3e50;">院校评分</h4>
                        <div class="rating-items-container">
                            <div class="rating-item">
                                <label>地理位置</label>
                                <div class="rating-stars" data-type="location">
                                    ${generateStars(isFavorite.locationRating || 0)}
                                </div>
                            </div>
                            <div class="rating-item">
                                <label>院校层次</label>
                                <div class="rating-stars" data-type="level">
                                    ${generateStars(isFavorite.levelRating || 0)}
                                </div>
                            </div>
                            <div class="rating-item">
                                <label>录取难度</label>
                                <div class="rating-stars" data-type="difficulty">
                                    ${generateStars(isFavorite.difficultyRating || 0)}
                                </div>
                            </div>
                        </div>
                        <div class="rating-item" style="margin-top: 15px;">
                            <textarea style="width: 100%; padding: 8px; margin-top: 5px;" 
                                placeholder="添加备注..."
                                onchange="updateNote('${school.name}', this.value)">${isFavorite.note || ''}</textarea>
                        </div>
                    </div>
                    ` : ''}

                    <div style="border-top: 1px solid #eee; padding-top: 10px;">
                        <h4 style="margin: 0 0 8px 0; color: #2c3e50;">招生专业信息：</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background-color: #f8f9fa;">
                                    <th style="border: 1px solid #e9ecef; padding: 8px; text-align: left;">院系</th>
                                    <th style="border: 1px solid #e9ecef; padding: 8px; text-align: left;">专业</th>
                                    <th style="border: 1px solid #e9ecef; padding: 8px; text-align: left;">研究方向</th>
                                    <th style="border: 1px solid #e9ecef; padding: 8px; text-align: left;">招生人数</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${school.departments.map(dept => `
                                    <tr>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.department}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.specialty}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.field}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.number}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <h4 style="margin: 16px 0 8px 0; color: #2c3e50;">考试科目：</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <tbody>
                                ${school.departments.map(dept => `
                                    <tr>
                                        <td colspan="4" style="border: 1px solid #e9ecef; padding: 8px; background-color: #f8f9fa;">
                                            <strong>${dept.department} - ${dept.field}</strong>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.subjects.subject1}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.subjects.subject2}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.subjects.subject3}</td>
                                        <td style="border: 1px solid #e9ecef; padding: 8px;">${dept.subjects.subject4}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // 添加评分事件监听
            if (isFavorite) {
                infoPanel.querySelectorAll('.rating-stars').forEach(container => {
                    container.querySelectorAll('.star').forEach((star, index) => {
                        star.addEventListener('click', () => {
                            const type = container.dataset.type;
                            updateRating(school.name, type, index + 1);
                        });
                    });
                });
            }
            
            infoPanel.style.display = 'block';

            // 高亮对应的标记
            const markers = map.getAllOverlays('marker');
            if (markers) {
                markers.forEach(marker => {
                    if (marker.getTitle() === school.name) {
                        // 如果之前有高亮的标记，先取消高亮
                        if (currentHighlightedMarker && currentHighlightedMarker !== marker) {
                            const prevTiers = getSchoolTier(currentHighlightedMarker.getTitle());
                            const prevTier = prevTiers.includes('985') ? '985' : (prevTiers.includes('211') ? '211' : 'normal');
                            updateMarkerState(currentHighlightedMarker, false, prevTier);
                        }
                        // 高亮当前标记
                        const tiers = getSchoolTier(school.name);
                        const tier = tiers.includes('985') ? '985' : (tiers.includes('211') ? '211' : 'normal');
                        updateMarkerState(marker, true, tier);
                        currentHighlightedMarker = marker;
                    }
                });
            }
        }

        // 生成星级评分HTML
        function generateStars(rating) {
            return Array(5).fill(0).map((_, i) => 
                `<span class="star ${i < rating ? 'active' : ''}" data-rating="${i + 1}">★</span>`
            ).join('');
        }

        // 切换收藏状态
        function toggleFavorite(schoolName) {
            if (favorites[schoolName]) {
                delete favorites[schoolName];
            } else {
                favorites[schoolName] = {
                    locationRating: 0,
                    levelRating: 0,
                    difficultyRating: 0,
                    note: ''
                };
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));
            
            // 重新显示学校信息
            const school = schools.find(s => s.name === schoolName);
            if (school) {
                showSchoolInfo(school);
            }
            
            // 如果在收藏标签，刷新表
            if (document.getElementById('favorites').classList.contains('active')) {
                createSchoolList(true);
            }
        }

        // 更新评分
        function updateRating(schoolName, type, rating) {
            if (favorites[schoolName]) {
                favorites[schoolName][type + 'Rating'] = rating;
                localStorage.setItem('favorites', JSON.stringify(favorites));
                
                // 更新星星显示
                const stars = document.querySelector(`[data-type="${type}"]`).children;
                Array.from(stars).forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            }
        }

        // 更新备注
        function updateNote(schoolName, note) {
            if (favorites[schoolName]) {
                favorites[schoolName].note = note;
                localStorage.setItem('favorites', JSON.stringify(favorites));
            }
        }

        // 更新标记状态
        function updateMarkerState(marker, isHighlighted, tier) {
            if (isHighlighted) {
                marker.setIcon(createHighlightIcon(tier));
                marker.setOffset(new AMap.Pixel(-20, -20));
            } else {
                marker.setIcon(createNormalIcon(tier));
                marker.setOffset(new AMap.Pixel(-16, -16));
            }
        }

        // 创建高亮图标
        function createHighlightIcon(tier) {
            const color = tier === '985' ? '#e74c3c' : (tier === '211' ? '#3498db' : '#95a5a6');
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
                    <circle cx="20" cy="20" r="18" fill="${color}" stroke="white" stroke-width="2"/>
                    ${tier !== 'normal' ? `<text x="20" y="25" text-anchor="middle" fill="white" font-size="12">${tier}</text>` : 
                    `<circle cx="20" cy="20" r="6" fill="white"/>`}
                </svg>
            `;
            return new AMap.Icon({
                image: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg),
                size: new AMap.Size(40, 40),
                imageSize: new AMap.Size(40, 40)
            });
        }

        // 创建普通图标
        function createNormalIcon(tier) {
            const color = tier === '985' ? '#e74c3c' : (tier === '211' ? '#3498db' : '#95a5a6');
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32">
                    <circle cx="16" cy="16" r="14" fill="${color}" stroke="white" stroke-width="2"/>
                    ${tier !== 'normal' ? `<text x="16" y="20" text-anchor="middle" fill="white" font-size="10">${tier}</text>` : 
                    `<circle cx="16" cy="16" r="5" fill="white"/>`}
                </svg>
            `;
            return new AMap.Icon({
                image: 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(svg),
                size: new AMap.Size(32, 32),
                imageSize: new AMap.Size(32, 32)
            });
        }

        // 修改省份双击处理函数
        function handleProvinceDoubleClick(provinceName) {
            console.log('双击省份:', provinceName);
            
            // 处理特殊省份名称
            let searchName = provinceName;
            if (provinceName === '内蒙古') searchName = '内蒙古自治区';
            else if (provinceName === '广西') searchName = '广西壮族自治区';
            else if (provinceName === '宁夏') searchName = '宁夏回族自治区';
            else if (provinceName === '新疆') searchName = '新疆维吾尔自治区';
            else if (provinceName === '西藏') searchName = '西藏自治区';
            else if (!provinceName.endsWith('省') && !provinceName.endsWith('市') && !provinceName.endsWith('自治区')) {
                searchName = provinceName + '省';
            }

            console.log('搜索名称:', searchName);

            // 清除已有的边界
            if (currentPolygon) {
                map.remove(currentPolygon);
                currentPolygon = null;
            }

            // 根据省份名称设置中心点和缩放级别
            const provinceCenter = {
                '北京市': [116.405285, 39.904989],
                '天津市': [117.190182, 39.125596],
                '河北省': [114.502461, 38.045474],
                '山西省': [112.549248, 37.857014],
                '内蒙古自治区': [111.670801, 40.818311],
                '辽宁省': [123.429096, 41.796767],
                '吉林省': [125.3245, 43.886841],
                '黑龙江省': [126.642464, 45.756967],
                '上海市': [121.472644, 31.231706],
                '江苏省': [118.767413, 32.041544],
                '浙江省': [120.153576, 30.287459],
                '安徽省': [117.283042, 31.86119],
                '福建省': [119.306239, 26.075302],
                '江西省': [115.892151, 28.676493],
                '山东省': [117.000923, 36.675807],
                '河南省': [113.665412, 34.757975],
                '湖北省': [114.298572, 30.584355],
                '湖南省': [112.982279, 28.19409],
                '广东省': [113.280637, 23.125178],
                '广西壮族自治区': [108.320004, 22.82402],
                '海南省': [110.33119, 20.031971],
                '重庆市': [106.504962, 29.533155],
                '四川省': [104.065735, 30.659462],
                '贵州省': [106.713478, 26.578343],
                '云南省': [102.712251, 25.040609],
                '西藏自治区': [91.132212, 29.660361],
                '陕西省': [108.948024, 34.263161],
                '甘肃省': [103.823557, 36.058039],
                '青海省': [101.778916, 36.623178],
                '宁夏回族自治区': [106.278179, 38.46637],
                '新疆维吾尔自治区': [87.617733, 43.792818]
            };

            // 为不同大小的省份设置不同的缩放级别
            const provinceZoom = {
                '北京市': 9,
                '天津市': 9,
                '上海市': 9,
                '重庆市': 9,
                '海南省': 8,
                '宁夏回族自治区': 7,
                '内蒙古自治区': 6,
                '新疆维吾尔自治区': 6,
                '西藏自治区': 6
            };

            const center = provinceCenter[searchName];
            if (center) {
                // 获取省份对应的缩放级别，如果没有特别指定则使用默认值7
                const zoomLevel = provinceZoom[searchName] || 7;
                
                // 先设置中心点和缩放级别
                map.setZoomAndCenter(zoomLevel, center);
                console.log('地图已缩放到省份，缩放级别:', zoomLevel);

                // 使用setTimeout确保地图缩放完成后再添加边界
                setTimeout(() => {
                    // 使用DistrictLayer显示省份边界
                    AMap.plugin(['AMap.DistrictLayer'], function() {
                        // 创建行政区图层
                        const districtLayer = new AMap.DistrictLayer.Province({
                            zIndex: 12,
                            adcode: [getProvinceAdcode(searchName)],
                            depth: 1,
                            styles: {
                                'fill': '#CCF3FF',
                                'province-stroke': '#CC66CC',
                                'city-stroke': '#CC66CC',
                                'fill-opacity': 0.4,
                                'province-stroke-width': 3,
                                'city-stroke-width': 2
                            }
                        });

                        // 添加图层到地图
                        currentPolygon = districtLayer;
                        map.add([districtLayer]);
                        console.log('省份边界已添加');
                    });
                }, 100);
            } else {
                console.log('未找到省份中心点');
            }
        }

        // 添加获取省份行政区划编码的函数
        function getProvinceAdcode(provinceName) {
            const adcodeMap = {
                '北京市': 110000,
                '天津市': 120000,
                '河北省': 130000,
                '山西省': 140000,
                '内蒙古自治区': 150000,
                '辽宁省': 210000,
                '吉林省': 220000,
                '黑龙江省': 230000,
                '上海市': 310000,
                '江苏省': 320000,
                '浙江省': 330000,
                '安徽省': 340000,
                '福建省': 350000,
                '江西省': 360000,
                '山东省': 370000,
                '河南省': 410000,
                '湖北省': 420000,
                '湖南省': 430000,
                '广东省': 440000,
                '广西壮族自治区': 450000,
                '海南省': 460000,
                '重庆市': 500000,
                '四川省': 510000,
                '贵州省': 520000,
                '云南省': 530000,
                '西藏自治区': 540000,
                '陕西省': 610000,
                '甘肃省': 620000,
                '青海省': 630000,
                '宁夏回族自治区': 640000,
                '新疆维吾尔自治区': 650000
            };
            return adcodeMap[provinceName] || null;
        }

        // 初始化地图
        function initMap() {
            map = new AMap.Map('map', {
                zoom: 4,
                center: [116.397428, 39.90923],
                resizeEnable: true
            });

            // 初始化行政区划插件
            AMap.plugin(['AMap.DistrictLayer', 'AMap.DistrictSearch'], function() {
                districtExplorer = new AMap.DistrictSearch({
                    level: 'province',
                    subdistrict: 0,
                    extensions: 'all'  // 返回行政区边界坐标点
                });
                console.log('地图插件初始化完成');
            });

            // 初始化卫星图层
            satelliteLayer = new AMap.TileLayer.Satellite();
            
            // 初始化热力图
            heatmap = new AMap.HeatMap(map, {
                radius: 25,
                opacity: [0, 0.8],
                gradient: {
                    0.2: '#8fce00',
                    0.4: '#4cc417',
                    0.6: '#ffd700',
                    0.8: '#ff6b6b',
                    1.0: '#cc1100'
                },
                zIndex: 120
            });

            // 准备热力图数据
            const heatmapData = schools.map(school => ({
                lng: school.location.longitude,
                lat: school.location.latitude,
                count: parseInt(school.total_students) || 1
            })).filter(data => data.count > 0);

            heatmap.setDataSet({
                data: heatmapData,
                max: Math.max(...heatmapData.map(d => d.count))
            });
            heatmap.hide();

            // 添加控件事件监听
            document.getElementById('zoomIn').addEventListener('click', () => {
                map.setZoom(map.getZoom() + 1);
            });

            document.getElementById('zoomOut').addEventListener('click', () => {
                map.setZoom(map.getZoom() - 1);
            });

            document.getElementById('zoomFit').addEventListener('click', () => {
                map.setZoomAndCenter(5, [104.1954, 35.8616]);
            });

            // 卫星图切换
            document.getElementById('satelliteToggle').addEventListener('click', () => {
                const button = document.getElementById('satelliteToggle');
                if (isSatelliteVisible) {
                    satelliteLayer.setMap(null);
                    button.classList.remove('active');
                } else {
                    satelliteLayer.setMap(map);
                    button.classList.add('active');
                }
                isSatelliteVisible = !isSatelliteVisible;
            });

            // 热力图切换
            document.getElementById('heatmapToggle').addEventListener('click', () => {
                const button = document.getElementById('heatmapToggle');
                if (isHeatmapVisible) {
                    heatmap.hide();
                    button.classList.remove('active');
                    // 恢复所有标记的显示
                    const markers = map.getAllOverlays('marker');
                    if (markers) {
                        markers.forEach(marker => {
                            marker.show();
                        });
                    }
                } else {
                    // 隐藏所有标记
                    const markers = map.getAllOverlays('marker');
                    if (markers) {
                        markers.forEach(marker => {
                            marker.hide();
                        });
                    }
                    // 显示热力图
                    heatmap.show();
                    button.classList.add('active');
                }
                isHeatmapVisible = !isHeatmapVisible;
            });

            // 添加标记
            schools.forEach(school => {
                if (school.location && school.location.longitude && school.location.latitude) {
                    const tiers = getSchoolTier(school.name);
                    let tier = tiers.includes('985') ? '985' : (tiers.includes('211') ? '211' : 'normal');
                    
                    let marker = new AMap.Marker({
                        map: map,
                        position: [school.location.longitude, school.location.latitude],
                        title: school.name,
                        icon: createNormalIcon(tier),
                        offset: new AMap.Pixel(-16, -16),
                        clickable: true
                    });

                    // 单击显示信息
                    marker.on('click', () => {
                        showSchoolInfo(school);
                        document.getElementById('schoolInfo').style.display = 'block';
                    });

                    // 双击缩放到学校位置
                    marker.on('dblclick', () => {
                        // 计算偏移后的中心点，向左偏移以避免被信息框遮挡
                        const offset = -0.025;  // 经度偏移量
                        map.setZoomAndCenter(14, [school.location.longitude + offset, school.location.latitude]);
                    });
                }
            });

            // 点击地图白处关闭信息面板和省份边界
            map.on('click', (e) => {
                const target = e.target;
                // 只有在点击地图本身，而不是标记时才关闭信息面板和清除边界
                if (target instanceof AMap.Map) {
                    document.getElementById('schoolInfo').style.display = 'none';
                    // 取消当前标记的高亮
                    if (currentHighlightedMarker) {
                        const tiers = getSchoolTier(currentHighlightedMarker.getTitle());
                        const tier = tiers.includes('985') ? '985' : (tiers.includes('211') ? '211' : 'normal');
                        updateMarkerState(currentHighlightedMarker, false, tier);
                        currentHighlightedMarker = null;
                    }
                    // 清除省份边界
                    if (currentPolygon) {
                        map.remove(currentPolygon);
                        currentPolygon = null;
                        console.log('清除省份边界');
                    }
                }
            });
        }

        // 修改createSchoolList函数以支持不同的视图模式
        function createSchoolList(showFavorites = false) {
            const schoolList = document.getElementById('schoolList');
            schoolList.innerHTML = '';
            
            let filteredSchools = showFavorites 
                ? schools.filter(school => favorites[school.name])
                : schools;

            if (currentView === 'province') {
                createProvinceView(filteredSchools);
            } else {
                createTierView(filteredSchools);
            }
        }

        // 按省份视图
        function createProvinceView(filteredSchools) {
            const schoolsByProvince = filteredSchools.reduce((acc, school) => {
                const province = school.province || '其他';
                if (!acc[province]) acc[province] = [];
                acc[province].push(school);
                return acc;
            }, {});

            const sortedProvinces = Object.keys(schoolsByProvince).sort();
            const schoolList = document.getElementById('schoolList');
            schoolList.innerHTML = '';
            
            sortedProvinces.forEach(province => {
                const provinceDiv = document.createElement('div');
                provinceDiv.className = 'province-group';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'province-header';
                headerDiv.innerHTML = `
                    <div class="province-title">
                        <span>${province}</span>
                        <div class="province-controls">
                            <button class="province-btn zoom-btn" title="缩放至省份范围">
                                <i class="fas fa-search-plus"></i>
                            </button>
                            <button class="province-btn expand-btn" title="展开/折叠学校列表">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                const schoolsDiv = document.createElement('div');
                schoolsDiv.className = 'province-schools';
                
                schoolsByProvince[province].forEach(school => {
                    const schoolDiv = createSchoolItem(school);
                    schoolsDiv.appendChild(schoolDiv);
                });
                
                // 添加缩放按钮事件
                const zoomBtn = headerDiv.querySelector('.zoom-btn');
                zoomBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    handleProvinceDoubleClick(province);
                });
                
                // 添加展开按钮事件
                const expandBtn = headerDiv.querySelector('.expand-btn');
                expandBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    headerDiv.classList.toggle('active');
                    schoolsDiv.classList.toggle('active');
                    // 切换展开按钮的图标
                    const icon = this.querySelector('i');
                    icon.classList.toggle('fa-chevron-down');
                    icon.classList.toggle('fa-chevron-up');
                });
                
                provinceDiv.appendChild(headerDiv);
                provinceDiv.appendChild(schoolsDiv);
                schoolList.appendChild(provinceDiv);
            });
        }

        // 按层级视图
        function createTierView(filteredSchools) {
            const schoolsByTier = {
                '985': [],
                '211': [],
                '普通院校': []
            };

            filteredSchools.forEach(school => {
                const tiers = getSchoolTier(school.name);
                if (tiers.length === 0) {
                    schoolsByTier['普通院校'].push(school);
                } else {
                    // 将学校添加到其最高层级
                    if (tiers.includes('985')) {
                        schoolsByTier['985'].push(school);
                    } else if (tiers.includes('211')) {
                        schoolsByTier['211'].push(school);
                    }
                }
            });

            const tiers = ['985', '211', '普通院校'];
            
            tiers.forEach(tier => {
                if (schoolsByTier[tier].length === 0) return;

                const tierDiv = document.createElement('div');
                tierDiv.className = 'tier-group';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'tier-header';
                headerDiv.innerHTML = `
                    <span>${tier}（${schoolsByTier[tier].length}所）</span>
                    <span class="arrow">▼</span>
                `;
                
                const schoolsDiv = document.createElement('div');
                schoolsDiv.className = 'tier-schools';
                
                schoolsByTier[tier].sort((a, b) => a.name.localeCompare(b.name)).forEach(school => {
                    const schoolDiv = createSchoolItem(school);
                    schoolsDiv.appendChild(schoolDiv);
                });
                
                headerDiv.addEventListener('click', () => {
                    headerDiv.classList.toggle('active');
                    schoolsDiv.classList.toggle('active');
                });
                
                tierDiv.appendChild(headerDiv);
                tierDiv.appendChild(schoolsDiv);
                schoolList.appendChild(tierDiv);
            });
        }

        // 创建学校列表项
        function createSchoolItem(school) {
            const schoolDiv = document.createElement('div');
            schoolDiv.className = 'school-item';
            const tiers = getSchoolTier(school.name);
            const tierLabels = tiers.length > 0 
                ? `<small style="color: #4a89dc;">[${tiers.join('/')}]</small>` 
                : '';
            
            schoolDiv.innerHTML = `
                <div>${school.name} ${tierLabels}</div>
                <small>招生人数：${school.total_students || '未知'}人</small>
            `;
            
            // 单击时缩放到学校位置并显示信息
            schoolDiv.addEventListener('click', () => {
                if (school.location && school.location.longitude && school.location.latitude) {
                    // 计算偏移后的中心点，向左偏移以避免被信息框遮挡
                    const offset = -0.025;  // 经度偏移量
                    map.setZoomAndCenter(14, [school.location.longitude + offset, school.location.latitude]);
                    showSchoolInfo(school);
                    document.getElementById('schoolInfo').style.display = 'block';
                }
            });
            
            return schoolDiv;
        }

        // 搜功能
        function initSearch() {
            const searchInput = document.getElementById('searchInput');
            const searchClear = document.getElementById('searchClear');
            
            // 处理搜索
            function handleSearch() {
                const searchText = searchInput.value.toLowerCase();
                const showFavorites = document.getElementById('favorites').classList.contains('active');
                const filteredSchools = showFavorites 
                    ? schools.filter(school => favorites[school.name])
                    : schools;

                if (currentView === 'province') {
                    // 处理按省份视图的搜索
                    document.querySelectorAll('.province-group').forEach(group => {
                        const schoolDivs = group.querySelectorAll('.school-item');
                        let hasVisibleSchools = false;
                        
                        schoolDivs.forEach(div => {
                            const schoolName = div.querySelector('div').textContent.toLowerCase();
                            const isVisible = schoolName.includes(searchText);
                            div.style.display = isVisible ? 'block' : 'none';
                            if (isVisible) hasVisibleSchools = true;
                        });
                        
                        group.style.display = hasVisibleSchools ? 'block' : 'none';
                        
                        // 如果有搜索文本，展开包含匹配学校的省份
                        if (searchText && hasVisibleSchools) {
                            const schoolsDiv = group.querySelector('.province-schools');
                            const header = group.querySelector('.province-header');
                            schoolsDiv.classList.add('active');
                            header.classList.add('active');
                        }
                    });
                } else {
                    // 处理按层级视图的搜索
                    document.querySelectorAll('.tier-group').forEach(group => {
                        const schoolDivs = group.querySelectorAll('.school-item');
                        let hasVisibleSchools = false;
                        
                        schoolDivs.forEach(div => {
                            const schoolName = div.querySelector('div').textContent.toLowerCase();
                            const isVisible = schoolName.includes(searchText);
                            div.style.display = isVisible ? 'block' : 'none';
                            if (isVisible) hasVisibleSchools = true;
                        });
                        
                        group.style.display = hasVisibleSchools ? 'block' : 'none';
                        
                        // 如果有搜索文本，展开包含匹配学校的层级
                        if (searchText && hasVisibleSchools) {
                            const schoolsDiv = group.querySelector('.tier-schools');
                            const header = group.querySelector('.tier-header');
                            schoolsDiv.classList.add('active');
                            header.classList.add('active');
                        }
                    });
                }
            }

            // 清除搜索
            function clearSearch() {
                searchInput.value = '';
                searchInput.focus();
                
                // 重置所有分组的显示状态
                if (currentView === 'province') {
                    document.querySelectorAll('.province-group').forEach(group => {
                        group.style.display = 'block';
                        const schoolsDiv = group.querySelector('.province-schools');
                        const header = group.querySelector('.province-header');
                        schoolsDiv.classList.remove('active');
                        header.classList.remove('active');
                    });
                } else {
                    document.querySelectorAll('.tier-group').forEach(group => {
                        group.style.display = 'block';
                        const schoolsDiv = group.querySelector('.tier-schools');
                        const header = group.querySelector('.tier-header');
                        schoolsDiv.classList.remove('active');
                        header.classList.remove('active');
                    });
                }
                
                // 重置所有学校项的显示状态
                document.querySelectorAll('.school-item').forEach(div => {
                    div.style.display = 'block';
                });
            }

            // 事件监听
            searchInput.addEventListener('input', handleSearch);
            searchClear.addEventListener('click', clearSearch);
            
            // 添加快捷键支持
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    clearSearch();
                }
            });
        }

        // 添加标签切换功能
        document.getElementById('allSchools').addEventListener('click', function() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('schoolList').style.display = 'block';
            createSchoolList(false);
        });

        document.getElementById('favorites').addEventListener('click', function() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('schoolList').style.display = 'block';
            createSchoolList(true);
        });

        // 添加图切换功能
        document.getElementById('viewByProvince').addEventListener('click', function() {
            if (currentView === 'province') return;
            this.classList.add('active');
            document.getElementById('viewByTier').classList.remove('active');
            currentView = 'province';
            createSchoolList(document.getElementById('favorites').classList.contains('active'));
        });

        document.getElementById('viewByTier').addEventListener('click', function() {
            if (currentView === 'tier') return;
            this.classList.add('active');
            document.getElementById('viewByProvince').classList.remove('active');
            currentView = 'tier';
            createSchoolList(document.getElementById('favorites').classList.contains('active'));
        });

        // 添加清空收藏功能
        document.getElementById('clearFavorites').addEventListener('click', function() {
            if (confirm('确定要清空所有收藏吗？此操作不可恢复。')) {
                // 清空收藏数据
                favorites = {};
                localStorage.setItem('favorites', JSON.stringify(favorites));
                
                // 如果当前在收藏页面，刷新列表
                if (document.getElementById('favorites').classList.contains('active')) {
                    createSchoolList(true);
                }
                
                // 如果信息面板正在显示，关闭它
                document.getElementById('schoolInfo').style.display = 'none';
                
                // 取消当前标记的高亮
                if (currentHighlightedMarker) {
                    const tiers = getSchoolTier(currentHighlightedMarker.getTitle());
                    const tier = tiers.includes('985') ? '985' : (tiers.includes('211') ? '211' : 'normal');
                    updateMarkerState(currentHighlightedMarker, false, tier);
                    currentHighlightedMarker = null;
                }
            }
        });

        // 添加统计功能相关的JavaScript代码
        function initStatistics() {
            if (typeof echarts === 'undefined') {
                console.error('ECharts库未加载，正在重试...');
                setTimeout(initStatistics, 1000);
                return;
            }

            try {
                // 初始化图表
                const provinceChart = echarts.init(document.getElementById('modalProvinceChart'));
                const tierChart = echarts.init(document.getElementById('modalTierChart'));
                const studentChart = echarts.init(document.getElementById('modalStudentChart'));

                // 计算数据
                const provinceData = {};
                schools.forEach(school => {
                    const province = school.province || '其他';
                    provinceData[province] = (provinceData[province] || 0) + 1;
                });

                const tierData = {
                    '985': 0,
                    '211': 0,
                    '普通院校': 0
                };
                schools.forEach(school => {
                    const tiers = getSchoolTier(school.name);
                    if (tiers.includes('985')) {
                        tierData['985']++;
                    } else if (tiers.includes('211')) {
                        tierData['211']++;
                    } else {
                        tierData['普通院校']++;
                    }
                });

                const studentData = {};
                schools.forEach(school => {
                    const province = school.province || '其他';
                    const students = parseInt(school.total_students) || 0;
                    studentData[province] = (studentData[province] || 0) + students;
                });

                // 省份学校数量柱状图
                provinceChart.setOption({
                    title: {
                        text: '各省份GIS院校数量分布',
                        left: 'center',
                        top: 10,
                        textStyle: {
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '5%',
                        right: '5%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: Object.keys(provinceData),
                        axisLabel: {
                            interval: 0,
                            rotate: 45,
                            fontSize: 12,
                            margin: 15
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '学校数量',
                        nameTextStyle: {
                            fontSize: 12
                        }
                    },
                    series: [{
                        data: Object.values(provinceData),
                        type: 'bar',
                        itemStyle: {
                            color: '#3498db'
                        }
                    }]
                });

                // 学校层级饼图
                tierChart.setOption({
                    title: {
                        text: 'GIS院校层级分布',
                        left: 'center',
                        top: 10,
                        textStyle: {
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'item',
                        formatter: '{b}: {c} ({d}%)'
                    },
                    legend: {
                        orient: 'horizontal',
                        bottom: 10,
                        left: 'center',
                        itemWidth: 25,
                        itemHeight: 14,
                        textStyle: {
                            fontSize: 12
                        }
                    },
                    series: [{
                        type: 'pie',
                        radius: ['40%', '70%'],
                        center: ['50%', '50%'],
                        avoidLabelOverlap: true,
                        itemStyle: {
                            borderRadius: 4
                        },
                        label: {
                            show: true,
                            position: 'inside',
                            formatter: '{d}%',
                            fontSize: 12,
                            color: '#fff'
                        },
                        data: [
                            { 
                                value: tierData['985'], 
                                name: '985院校',
                                itemStyle: { color: '#e74c3c' }
                            },
                            { 
                                value: tierData['211'], 
                                name: '211院校',
                                itemStyle: { color: '#3498db' }
                            },
                            { 
                                value: tierData['普通院校'], 
                                name: '普通院校',
                                itemStyle: { color: '#95a5a6' }
                            }
                        ]
                    }]
                });

                // 各省份招生人数柱状图
                studentChart.setOption({
                    title: {
                        text: '各省份GIS专业招生人数',
                        left: 'center',
                        top: 10,
                        textStyle: {
                            fontSize: 16
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        }
                    },
                    grid: {
                        left: '5%',
                        right: '5%',
                        bottom: '15%',
                        top: '15%',
                        containLabel: true
                    },
                    xAxis: {
                        type: 'category',
                        data: Object.keys(studentData),
                        axisLabel: {
                            interval: 0,
                            rotate: 45,
                            fontSize: 12,
                            margin: 15
                        }
                    },
                    yAxis: {
                        type: 'value',
                        name: '招生人数',
                        nameTextStyle: {
                            fontSize: 12
                        }
                    },
                    series: [{
                        data: Object.values(studentData),
                        type: 'bar',
                        itemStyle: {
                            color: '#2ecc71'
                        }
                    }]
                });

                // 监听窗口大小变化
                window.addEventListener('resize', function() {
                    provinceChart.resize();
                    tierChart.resize();
                    studentChart.resize();
                });
            } catch (error) {
                console.error('初始化图表时出错:', error);
            }
        }

        // 修改tab切换逻辑
        document.getElementById('statistics').addEventListener('click', function() {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // 显示模态框
            document.getElementById('statisticsModal').style.display = 'block';
            
            // 初始化图表
            setTimeout(initStatistics, 100);
        });

        // 添加关闭模态框的事件
        document.querySelector('.close-btn').addEventListener('click', function() {
            document.getElementById('statisticsModal').style.display = 'none';
            // 取消统计按钮的激活状态
            document.getElementById('statistics').classList.remove('active');
            // 重新激活"所有院校"按钮
            document.getElementById('allSchools').classList.add('active');
        });

        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('statisticsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
                // 取消统计按钮的激活状态
                document.getElementById('statistics').classList.remove('active');
                // 重新激活"所有院校"按钮
                document.getElementById('allSchools').classList.add('active');
            }
        });

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html> 